##
## Distribution of vulnerability and deprivation within Tactical Cells
##
library(tidyverse)
library(cowplot)

source("functions.r")
source("load lookup tables.r")
source("create lookup table - neighbourhood to Tactical Cell.r")

#' invert deciles
#' @param x Deciles
#' 
reverse_decile = function(x) 11 - x

##
## load population estimates
##
source("https://github.com/britishredcrosssociety/covid-19-vulnerability/raw/master/prep%20population%20estimates.r")

pop = bind_rows(pop_eng, pop_sco, pop_ni)


##
## load vulnerability
##
vi = read_csv("https://github.com/britishredcrosssociety/covid-19-vulnerability/raw/master/output/vulnerability-MSOA-UK.csv") %>% 
  left_join(msoa_lad_tc, by = c("Code" = "MSOA11CD"))

# manually point out if Northern Ireland cell
vi = vi %>% mutate(TacticalCell = ifelse(str_sub(Code, 1, 1) == "9", "Northern Ireland and Isle of Man", TacticalCell))

# convert deciles to a factor and label the least and most vulnerable
vi$Decile = factor(vi$`Vulnerability decile`)
levels(vi$Decile)[levels(vi$Decile) %in% c("1", "10")] = c("1 (least vulnerable)", "10 (most vulnerable)")

##
## load deprivation
##
imd = read_csv("https://github.com/matthewgthomas/IMD/raw/master/data/UK%20IMD%20domains.csv") 
imd = imd %>% 
  left_join(lsoa_lad_tc, by = c("LSOA" = "LSOA11CD"))

# manually point out if Northern Ireland cell
imd = imd %>% mutate(TacticalCell = ifelse(str_sub(LSOA, 1, 1) == "9", "Northern Ireland and Isle of Man", TacticalCell))

# convert deciles to a factor and label the least and most vulnerable
imd$IMD_decile = reverse_decile(imd$IMD_decile)
imd$Decile = factor(imd$IMD_decile)
levels(imd$Decile)[levels(imd$Decile) %in% c("1", "10")] = c("1 (least deprivation)", "10 (most deprivation)")

##
## summarise deprivation into MSOAs
##


##
## loop over all Cells, plotting and saving graphs
##
tc_names = unique(vi$TacticalCell)

# tc_curr = "South and the Channel Islands"
for (tc_curr in tc_names) {
  ##
  ## distribution of vulnerability deciles within TCs
  ##
  # label
  vi_sum = vi %>% 
    filter(TacticalCell == tc_curr) %>% 
    janitor::tabyl(`Vulnerability decile`) %>% 
    mutate(percent = round(percent * 100, 0))
  
  vi_sum_least = vi_sum %>% filter(`Vulnerability decile` == 1)
  vi_sum_most = vi_sum %>% filter(`Vulnerability decile` == 10)
  
  labA = paste0(vi_sum_least$percent, "% of areas are among country's least vulnerable\n", vi_sum_most$percent, "% of areas are among country's most vulnerable")
  
  ann_text1 = data.frame(Decile = 5, values = 175)  # where to place the annotation
  
  plt_vi = vi %>% 
    filter(TacticalCell == tc_curr) %>% 
    ggplot(aes(x = Decile)) +
    geom_bar(fill = "#f1864e") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = NULL, y = "Number of neighbourhoods", title = "Vulnerability decile")
    # 
    # geom_text(data = ann_text1, aes(x = Decile, y = values), 
    #           label = labA, colour="Grey40") 
  
  
  ##
  ## distribution of deprivation deciles within TCs
  ##
  # label
  imd_sum = imd %>% 
    filter(TacticalCell == tc_curr) %>% 
    janitor::tabyl(IMD_decile) %>% 
    mutate(percent = round(percent * 100, 0))
  
  imd_sum_least = imd_sum %>% filter(IMD_decile == 1)
  imd_sum_most = imd_sum %>% filter(IMD_decile == 10)
  
  labA = paste0(imd_sum_least$percent, "% of areas are among country's least deprived\n", imd_sum_most$percent, "% of areas are among country's most deprived")
  
  ann_text1 = data.frame(Decile = 5, values = 750)  # where to place the annotation
  
  plt_imd = imd %>% 
    filter(TacticalCell == tc_curr) %>% 
    ggplot(aes(x = Decile)) +
    geom_bar(fill = "#f1864e") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = NULL, y = "Number of neighbourhoods", title = "Deprivation decile")
    # 
    # geom_text(data = ann_text1, aes(x = Decile, y = values), 
    #           label = labA, colour="Grey40") 
  
  
  ##
  ## distribution of population by vulnerability decile
  ##
  vi_pop = vi %>% 
    filter(TacticalCell == tc_curr) %>% 
    left_join(pop, by = "Code") %>% 
    
    group_by(Decile) %>% 
    summarise(`No. people` = sum(`No. people`, na.rm = TRUE))

  plt_vi_pop = vi_pop %>% 
    ggplot(aes(x = Decile, y = `No. people`)) +
    geom_col(fill = "#f1864e") +
    scale_y_continuous(labels = scales::comma) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = NULL, y = "Number of people", title = "Vulnerability decile")
  
  
  ##
  ## save plots
  ##
  if (!dir.exists(file.path("output", tc_curr))) dir.create(file.path("output", tc_curr))  # create folder for this Cell if needed
  
  # plot_grid(plt_vi, plt_imd, nrow = 2, ncol = 1)
  # ggsave(file.path("output", tc_curr, "vulnerability and deprivation.png"), width = 100, height = 200, units = "mm")
  
  ggsave(file.path("output", tc_curr, "vulnerability.png"), plot = plt_vi,  width = 100, height = 100, units = "mm")
  ggsave(file.path("output", tc_curr, "deprivation.png"),   plot = plt_imd, width = 100, height = 100, units = "mm")
  ggsave(file.path("output", tc_curr, "vulnerability and population.png"), plot = plt_vi_pop, width = 100, height = 100, units = "mm")
  
  print(paste0("Finished ", tc_curr))

}
